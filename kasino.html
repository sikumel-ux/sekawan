<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin TUNTAS - RT 04</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #F1F5F9; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:100; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(4px); }
        .modal-content { background:white; padding:24px; border-radius:2.5rem; width:100%; max-width:400px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.2); }
        .modern-in { width:100%; padding:14px 18px; background:#F8FAFC; border:1px solid #E2E8F0; border-radius:1.2rem; outline:none; transition:all 0.2s; font-size: 14px; }
        .modern-in:focus { border-color:#059669; background: white; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        .btn-primary { width:100%; background:#064E3B; color:white; padding:16px; border-radius:1.2rem; font-weight:800; font-size:14px; letter-spacing:1px; transition:all 0.2s; box-shadow: 0 10px 15px -3px rgba(6, 78, 59, 0.3); }
        .btn-primary:active { scale:0.95; }
        .bento-card { background:white; padding:18px; border-radius:1.8rem; border:1px solid #F1F5F9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    </style>
</head>
<body onload="init()">

    <div id="mIuran" class="modal" onclick="if(event.target==this)closeModal('mIuran')">
        <div class="modal-content space-y-4">
            <h3 class="text-lg font-extrabold text-center uppercase tracking-widest text-emerald-900">Bayar Iuran</h3>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nama Warga</label>
                <select id="iNama" class="modern-in font-bold text-slate-700 mt-1"></select>
            </div>
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1 block mb-2">Pilih Bulan (Bisa Lebih Dari Satu)</label>
                <div id="containerBulanIuran" class="grid grid-cols-3 gap-2 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                    </div>
            </div>

            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Total Bayar (Rp)</label>
                <input type="number" id="iNom" class="modern-in font-extrabold text-xl text-emerald-700 mt-1" placeholder="Nominal">
                <p class="text-[9px] text-emerald-600 mt-1 font-bold italic ml-1">*Otomatis: 50rb x jumlah bulan</p>
            </div>

            <button onclick="simpanIuran()" class="btn-primary">SIMPAN & BUAT KUITANSI</button>
        </div>
    </div>

    <div id="mAnggota" class="modal" onclick="if(event.target==this)closeModal('mAnggota')">
        <div class="modal-content space-y-4">
            <h3 class="text-lg font-extrabold text-center uppercase tracking-widest text-slate-800">Tambah Warga</h3>
            <input type="text" id="aNama" class="modern-in uppercase font-bold" placeholder="Nama Lengkap">
            <input type="number" id="aHp" class="modern-in" placeholder="No. WA (Contoh: 0812...)">
            <button onclick="simpanAnggota()" class="btn-primary bg-slate-800">TAMBAH WARGA</button>
        </div>
    </div>

    <div id="mShare" class="modal">
        <div class="modal-content space-y-6 text-center">
            <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto">
                <span class="material-symbols-rounded text-4xl">check_circle</span>
            </div>
            <div>
                <h3 class="text-xl font-extrabold text-slate-800">Berhasil Dicatat!</h3>
                <p class="text-slate-400 text-sm">Kirim bukti pembayaran ke warga melalui WhatsApp?</p>
            </div>
            <button id="btnWA" class="btn-primary flex items-center justify-center gap-2 bg-green-600 shadow-green-100">
                <span class="material-symbols-rounded">send</span> KIRIM WHATSAPP
            </button>
            <button onclick="closeModal('mShare')" class="text-slate-400 font-bold text-sm block w-full py-2">TUTUP</button>
        </div>
    </div>

    <div id="mainApp" class="p-6 max-w-md mx-auto space-y-6 pb-24">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-black text-emerald-900 leading-none">TUNTAS.</h1>
                <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest mt-1">Admin RT 04 Dongkelan</p>
            </div>
            <button onclick="openModal('mIuran')" class="bg-emerald-700 text-white p-4 rounded-2xl shadow-xl active:scale-95 transition-all">
                <span class="material-symbols-rounded">add_card</span>
            </button>
        </div>

        <div class="bg-emerald-900 p-6 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-800 rounded-full opacity-50"></div>
            <p class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-70">Kelola Data Warga</p>
            <h2 class="text-lg font-bold mt-1 italic">Turun Tangan Atasi Sampah</h2>
        </div>

        <button onclick="openModal('mAnggota')" class="w-full bg-white p-5 rounded-3xl border-2 border-dashed border-slate-200 text-slate-400 font-bold text-xs uppercase tracking-widest hover:border-emerald-500 hover:text-emerald-500 transition-all flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-sm">person_add</span> Tambah Warga Baru
        </button>

        <div id="tBodyIur" class="space-y-3">
            </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyDjxOJZeiLHaxoaS3-hVdbIGfIXCfCT2Is",
            authDomain: "tuntas-sekawan.firebaseapp.com",
            projectId: "tuntas-sekawan",
            storageBucket: "tuntas-sekawan.firebasestorage.app",
            messagingSenderId: "1090506516563",
            appId: "1:1090506516563:web:63c429677caea28addfea6"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();
        
        const daftarBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const tarifPerBulan = 50000;
        let dataWarga = {};

        function init() {
            renderPilihanBulan();
            loadData();
        }

        function renderPilihanBulan() {
            const cont = document.getElementById('containerBulanIuran');
            cont.innerHTML = '';
            daftarBulan.forEach(bln => {
                cont.innerHTML += `
                    <label class="relative block">
                        <input type="checkbox" name="blnCek" value="${bln}" class="hidden peer" onchange="hitungIuranOtomatis()">
                        <div class="cursor-pointer text-[10px] font-bold py-2.5 text-center border border-slate-200 rounded-xl bg-white text-slate-400 peer-checked:bg-emerald-600 peer-checked:text-white peer-checked:border-emerald-600 transition-all shadow-sm">
                            ${bln.substring(0,3)}
                        </div>
                    </label>`;
            });
        }

        function hitungIuranOtomatis() {
            const jml = document.querySelectorAll('input[name="blnCek"]:checked').length;
            document.getElementById('iNom').value = jml * tarifPerBulan;
        }

        async function loadData() {
            const [dang] = await Promise.all([
                db.collection("anggota").orderBy("nama","asc").get()
            ]);

            const ti = document.getElementById('tBodyIur'), sel = document.getElementById('iNama');
            ti.innerHTML=''; sel.innerHTML='<option value="">Pilih Warga</option>';
            dataWarga = {};

            dang.docs.forEach(doc => {
                const d = doc.data(), n = d.nama;
                dataWarga[n] = d.hp || '';
                sel.insertAdjacentHTML('beforeend', `<option value="${n}">${n}</option>`);
                
                ti.insertAdjacentHTML('beforeend', `
                    <div class="bento-card flex justify-between items-center bg-white">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-700 flex items-center justify-center font-black text-sm shadow-sm border border-emerald-100">${n.charAt(0)}</div>
                            <div>
                                <p class="font-black text-sm uppercase text-slate-800 leading-tight">${n}</p>
                                <p class="text-[9px] text-slate-400 font-bold mt-1">${d.hp || 'TIDAK ADA NO HP'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="hapus('anggota','${doc.id}')" class="w-8 h-8 rounded-full bg-rose-50 text-rose-400 flex items-center justify-center hover:bg-rose-500 hover:text-white transition-all"><span class="material-symbols-rounded text-lg">delete</span></button>
                        </div>
                    </div>`);
            });
        }

        async function simpanIuran() {
            const n = document.getElementById('iNama').value;
            const nmn = Number(document.getElementById('iNom').value);
            const bulanTerpilih = Array.from(document.querySelectorAll('input[name="blnCek"]:checked')).map(c => c.value);
            
            if(!n || bulanTerpilih.length === 0 || !nmn) return alert("⚠️ Pilih warga dan centang bulannya!");

            const kode = 'T' + Date.now().toString().slice(-6);
            const teksBulan = bulanTerpilih.join(", ");

            try {
                await db.collection("kwitansi").doc(kode).set({ 
                    nama: n, 
                    bulan: teksBulan, 
                    nominal: nmn, 
                    tgl: firebase.firestore.FieldValue.serverTimestamp(), 
                    kode: kode,
                    wa: dataWarga[n] || ''
                }); 

                closeModal('mIuran');
                renderPilihanBulan(); // Reset checkbox
                document.getElementById('iNom').value = '';
                loadData(); 
                showShareModal(n, nmn, teksBulan, kode);
            } catch (e) {
                alert("Gagal simpan: " + e.message);
            }
        }

        function showShareModal(nama, nominal, bulan, kode) {
            const hp = dataWarga[nama] || '';
            const linkBukti = `${window.location.origin}/kuitansi.html?id=${kode}`; 
            
            // Format Pesan Sesuai Request Bro
            const msg = `*BUKTI PEMBAYARAN TUNTAS*%0A` +
                        `---------------------------%0A` +
                        `*Nama:* ${nama}%0A` +
                        `*Nominal:* Rp ${nominal.toLocaleString('id-ID')}%0A` +
                        `*Kode:* ${kode}%0A` +
                        `---------------------------%0A` +
                        `*Link e-Kuitansi Anda:*%0A` +
                        `${linkBukti}%0A` +
                        `---------------------------%0A` +
                        `_Terima kasih atas partisipasinya._%0A%0A` +
                        `Pengurus Tuntas,%0A%0A` +
                        `*APRIYANTO*`;
            
            document.getElementById('btnWA').onclick = () => {
                let phone = hp;
                if (!phone) return alert("❌ Warga tidak punya No HP!");
                if (phone.startsWith('0')) phone = '62' + phone.slice(1);
                window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
            };
            openModal('mShare');
        }

        async function simpanAnggota() {
            const n = document.getElementById('aNama').value.toUpperCase(), h = document.getElementById('aHp').value;
            if(n) { 
                await db.collection("anggota").add({ nama: n, hp: h }); 
                closeModal('mAnggota'); 
                document.getElementById('aNama').value = '';
                document.getElementById('aHp').value = '';
                loadData(); 
            }
        }

        async function hapus(c, id) { if(confirm("Hapus data ini?")) { await db.collection(c).doc(id).delete(); loadData(); } }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
    </script>
</body>
  </html>
                  
