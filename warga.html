<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TUNTAS - Portal Warga</title>
    
    <link rel="stylesheet" href="warga.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-5">

<div id="mainApp" class="max-w-md mx-auto">
    <header class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-emerald-900 flex items-center justify-center text-white"><span class="material-symbols-rounded text-sm">leaf</span></div>
            <div>
                <h1 class="text-xl font-extrabold text-emerald-900 leading-none">Tuntas.</h1>
                <p class="text-[8px] font-bold text-emerald-600 uppercase tracking-widest">Portal Warga RT 04</p>
            </div>
        </div>
        <div class="w-10 h-10 rounded-xl bg-white border flex items-center justify-center text-emerald-900 shadow-sm">
            <span class="material-symbols-rounded">notifications</span>
        </div>
    </header>

    <div id="screen-home" class="tab-content active space-y-4">
        <div class="card-accent relative overflow-hidden">
            <p class="text-[10px] font-bold opacity-70 mb-1 tracking-widest uppercase text-emerald-100">Saldo Kas RT 04</p>
            <h2 id="totalSaldo" class="text-4xl font-extrabold">Rp 0</h2>
            <span class="material-symbols-rounded absolute -right-4 -bottom-4 text-8xl opacity-10">payments</span>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="bento-card border-l-4 border-emerald-500">
                <p class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-2">Total Masuk</p>
                <p id="totalMasuk" class="text-lg font-extrabold text-emerald-700 leading-none">0</p>
            </div>
            <div class="bento-card border-l-4 border-red-500">
                <p class="text-[10px] font-bold text-slate-400 uppercase leading-none mb-2">Total Keluar</p>
                <p id="totalKeluar" class="text-lg font-extrabold text-red-600 leading-none">0</p>
            </div>
        </div>

        <div class="bento-card space-y-3">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Riwayat Kas Terbaru</p>
            <div id="historyWarga" class="space-y-3">
                </div>
        </div>
    </div>

    <div id="screen-aturan" class="tab-content space-y-4">
        <h2 class="text-xl font-extrabold text-emerald-900 px-2">Aturan TUNTAS</h2>
        <div class="bento-card space-y-4">
            <div class="flex gap-4">
                <span class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center shrink-0 font-bold">1</span>
                <p class="text-sm text-slate-600">Sampah harus dibungkus plastik/karung rapi sebelum ditaruh di depan rumah.</p>
            </div>
            <div class="flex gap-4">
                <span class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center shrink-0 font-bold">2</span>
                <p class="text-sm text-slate-600">Dilarang mencampur sampah B3 (Baterai, Lampu, Elektronik) dengan sampah domestik.</p>
            </div>
            <div class="flex gap-4">
                <span class="w-8 h-8 rounded-lg bg-red-100 text-red-700 flex items-center justify-center shrink-0 font-bold">!</span>
                <p class="text-sm text-slate-600">Jadwal angkut hari <b>Minggu & Kamis</b> jam 07.00 WIB.</p>
            </div>
        </div>
    </div>

    <div id="screen-faq" class="tab-content space-y-4">
        <h2 class="text-xl font-extrabold text-emerald-900 px-2">Pertanyaan Umum</h2>
        <div class="space-y-3">
            <details class="bento-card group">
                <summary class="list-none flex justify-between items-center cursor-pointer font-bold text-sm text-slate-700">
                    Ke mana uang iuran disalurkan?
                    <span class="material-symbols-rounded transition-transform group-open:rotate-180">expand_more</span>
                </summary>
                <p class="text-xs text-slate-500 mt-3 pt-3 border-t">Digunakan untuk gaji petugas angkut, pemeliharaan alat, dan kas sosial warga RT 04.</p>
            </details>
            <details class="bento-card group">
                <summary class="list-none flex justify-between items-center cursor-pointer font-bold text-sm text-slate-700">
                    Bagaimana cara daftar baru?
                    <span class="material-symbols-rounded transition-transform group-open:rotate-180">expand_more</span>
                </summary>
                <p class="text-xs text-slate-500 mt-3 pt-3 border-t">Silakan hubungi Ketua RT atau Admin Tuntas melalui WhatsApp yang tertera.</p>
            </details>
        </div>
        
        <a href="https://wa.me/6287812710851" class="flex items-center justify-center gap-3 p-5 bg-green-600 text-white rounded-[20px] font-bold shadow-lg mt-8">
            <span class="material-symbols-rounded">chat</span> HUBUNGI ADMIN
        </a>
    </div>

    <nav class="fixed bottom-0 inset-x-0 h-20 flex justify-around items-center px-6">
        <button onclick="st('home')" id="n-home" class="active flex flex-col items-center gap-1">
            <span class="material-symbols-rounded">home</span>
            <span class="text-[10px] font-bold uppercase">Home</span>
        </button>
        <button onclick="st('aturan')" id="n-aturan" class="flex flex-col items-center gap-1">
            <span class="material-symbols-rounded">gavel</span>
            <span class="text-[10px] font-bold uppercase">Aturan</span>
        </button>
        <button onclick="st('faq')" id="n-faq" class="flex flex-col items-center gap-1">
            <span class="material-symbols-rounded">quiz</span>
            <span class="text-[10px] font-bold uppercase">FAQ</span>
        </button>
    </nav>
</div>

<script>
    // Config Firebase
    const config = {
        apiKey: "AIzaSyDjxOJZeiLHaxoaS3-hVdbIGfIXCfCT2Is",
        authDomain: "tuntas-sekawan.firebaseapp.com",
        projectId: "tuntas-sekawan",
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();

    // DATA DUMMY (Akan diganti data asli jika Firebase sudah ada isinya)
    const dummyHistory = [
        { ket: "Iuran Warga Jan - Bp. Andi", kat: "Masuk", nom: 20000, tgl: "01/02" },
        { ket: "Bensin Motor Sampah", kat: "Keluar", nom: 15000, tgl: "02/02" },
        { ket: "Iuran Warga Jan - Ibu Siti", kat: "Masuk", nom: 20000, tgl: "02/02" }
    ];

    async function loadDataWarga() {
        try {
            const [snapKas, snapIur] = await Promise.all([
                db.collection("kas").orderBy("tgl", "desc").limit(5).get(),
                db.collection("pembayaran").orderBy("tgl", "desc").limit(5).get()
            ]);

            let totalIn = 0, totalOut = 0;
            const container = document.getElementById('historyWarga');
            container.innerHTML = '';

            // Jika database kosong, tampilkan dummy
            if (snapKas.empty && snapIur.empty) {
                renderDummy();
                return;
            }

            // Hitung & Render (Sederhana untuk warga)
            snapKas.forEach(doc => {
                const d = doc.data();
                if(d.kat === 'Masuk') totalIn += d.nom; else totalOut += d.nom;
                container.insertAdjacentHTML('beforeend', renderRow(d.ket, d.kat, d.nom, d.tgl.toDate()));
            });

            // Tampilkan angka akhir
            const saldo = totalIn - totalOut;
            document.getElementById('totalSaldo').innerText = 'Rp ' + saldo.toLocaleString('id-ID');
            document.getElementById('totalMasuk').innerText = totalIn.toLocaleString('id-ID');
            document.getElementById('totalKeluar').innerText = totalOut.toLocaleString('id-ID');

        } catch (e) {
            console.log("Load data gagal, menggunakan dummy...");
            renderDummy();
        }
    }

    function renderRow(ket, kat, nom, tgl) {
        const t = typeof tgl === 'string' ? tgl : `${tgl.getDate()}/${tgl.getMonth()+1}`;
        return `
            <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                <div class="flex gap-3">
                    <span class="text-[9px] font-bold text-slate-400 bg-slate-50 p-1 px-2 rounded-md h-fit">${t}</span>
                    <div>
                        <p class="text-xs font-bold uppercase text-slate-700 line-clamp-1">${ket}</p>
                        <p class="text-[8px] font-bold ${kat==='Masuk'?'text-emerald-500':'text-red-400'} uppercase">${kat}</p>
                    </div>
                </div>
                <p class="text-xs font-extrabold ${kat==='Masuk'?'text-emerald-700':'text-red-500'}">${nom.toLocaleString('id-ID')}</p>
            </div>`;
    }

    function renderDummy() {
        document.getElementById('totalSaldo').innerText = 'Rp 25.000';
        document.getElementById('totalMasuk').innerText = '40.000';
        document.getElementById('totalKeluar').innerText = '15.000';
        const container = document.getElementById('historyWarga');
        dummyHistory.forEach(d => {
            container.insertAdjacentHTML('beforeend', renderRow(d.ket, d.kat, d.nom, d.tgl));
        });
    }

    function st(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('screen-'+t).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('n-'+t).classList.add('active');
    }

    // Jalankan load data
    loadDataWarga();
</script>
</body>
</html>
